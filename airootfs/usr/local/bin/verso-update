#!/bin/bash

# --- COULEURS ---
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}:: Recherche de mises à jour...${NC}"

# 1. Vérification d'internet
if ! ping -c 1 8.8.8.8 &> /dev/null; then
    echo -e "${RED}Erreur : Pas de connexion internet.${NC}"
    exit 1
fi

# ==============================================================================
# 2. MISE À JOUR DES SCRIPTS VERSO (Depuis GitHub)
# ==============================================================================
echo -e "${BLUE}:: Vérification des scripts système (GitHub)...${NC}"

REPO_URL="https://github.com/dadd3n524/verso-os.git"
REPO_DIR="$HOME/.verso-os-source"

# A. Récupère le code source
if [ -d "$REPO_DIR" ]; then
    # Le dossier existe, on met à jour (silencieusement)
    git -C "$REPO_DIR" pull --quiet
else
    # Si le dossier n'existe pas, on clone
    echo "Téléchargement des sources..."
    git clone --quiet "$REPO_URL" "$REPO_DIR"
fi

# B. Installe les scripts (nécessite sudo)
if [ -d "$REPO_DIR/usr/local/bin" ]; then
    # Compare ou on écrase directement
    # Note : sudo demandera le mot de passe ici si nécessaire
    sudo cp -rf "$REPO_DIR/usr/local/bin/"* /usr/local/bin/
    sudo chmod +x /usr/local/bin/*
    echo -e "${GREEN}✓ Scripts Verso synchronisés.${NC}"
fi

# ==============================================================================
# 3. VERIFICATION SYSTÈME (Arch & AUR)
# ==============================================================================

# Vérification des dépôts officiels (sans sudo)
# Nécessite le paquet 'pacman-contrib'
if command -v checkupdates &> /dev/null; then
    OFFICIAL_UPDATES=$(checkupdates | wc -l)
else
    echo "Outil 'checkupdates' manquant. Utilisation de pacman..."
    OFFICIAL_UPDATES="?"
fi

# Vérification AUR (si yay est installé)
AUR_UPDATES=0
if command -v yay &> /dev/null; then
    AUR_UPDATES=$(yay -Qua | wc -l)
fi

# Calcul du total
if [[ "$OFFICIAL_UPDATES" != "?" ]]; then
    TOTAL=$((OFFICIAL_UPDATES + AUR_UPDATES))
else
    TOTAL="?"
fi

# --- AFFICHAGE ET DÉCISION ---

if [[ "$TOTAL" == "0" ]]; then
    echo -e "${GREEN}✓ Votre système (Arch/AUR) est à jour.${NC}"
    exit 0
else
    echo ""
    echo -e "${BLUE}=== RAPPORT DE MISE À JOUR ===${NC}"
    echo -e "Paquets système (Arch) : ${GREEN}$OFFICIAL_UPDATES${NC}"
    echo -e "Paquets AUR (Brave, etc) : ${GREEN}$AUR_UPDATES${NC}"
    echo ""
   
    # Prompt utilisateur
    read -p "Voulez-vous lancer la mise à jour maintenant ? (o/n) : " REPONSE
   
    if [[ "$REPONSE" == "o" || "$REPONSE" == "O" ]]; then
        echo ""
        echo -e "${BLUE}:: Lancement de la mise à jour...${NC}"
       
        # Mise à jour combinée (System + AUR)
        # Si yay est là, il gère tout. Sinon, pacman.
        if command -v yay &> /dev/null; then
            yay -Syu
        else
            sudo pacman -Syu
        fi
       
        echo ""
        echo -e "${GREEN}Terminé !${NC}"
        sleep 2
    else
        echo "Mise à jour reportée."
    fi
fi

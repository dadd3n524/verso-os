#!/bin/bash

# ==============================================================================
# ðŸ”„ SYNC-VERSO-DEV : SYNCHRONISATION DEV -> ISO (CORRIGÃ‰ & COMPLET)
# ==============================================================================

# --- CONFIGURATION ---
ISO_DIR="$HOME/verso-iso"
AIROOTFS="$ISO_DIR/airootfs"
SKEL="$AIROOTFS/etc/skel"
SKEL_CONFIG="$SKEL/.config"
BIN_DEST="$AIROOTFS/usr/local/bin"

# --- COULEURS ---
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- 1. LISTE DES SCRIPTS (/usr/local/bin) ---
# J'ai ajoutÃ© : group_all_windows, smart_close, record-screen, verso-edit, verso_menu
SCRIPTS_TO_SYNC=(
    "alfred"
    "browser-home"
    "group_all_windows"
    "grouped-windows.sh"
    "menu_applis"
    "record-screen"
    "reload_interface"
    "safe_quit"
    "scroll"
    "smart_close"
    "smart_open"
    "sys_monitor"
    "toggle_audio"
    "toggle_backlight"
    "toggle_help"
    "toggle_power"
    "toggle_tasks"
    "verso_backlight_ui"
    "verso-browser"
    "verso-edit"
    "verso-install-brave"
    "verso-loading"
    "verso_menu"
    "verso_power_ui"
    "verso_search"
    "verso-update"
    "verso-welcome"
    "zapping.sh"
)

# --- 2. LISTE DES DOSSIERS DE CONFIG (~/.config) ---
# J'ai ajoutÃ© : mpv, rofi, wofi, gtk-4.0, qt5ct, qt6ct, Kvantum, nwg-look/drawer
CONFIGS_TO_SYNC=(
    "hypr"
    "waybar"
    "kitty"
    "micro"
    "gtk-3.0"
    "gtk-4.0"
    "dconf"
    "btop"
    "menus"
    "volumeicon"
    "mimeapps.list"
    "dolphinrc"
    "verso_help.txt"
    "mpv"
    "rofi"
    "wofi"
    "nwg-look"
    "nwg-drawer"
    "qt5ct"
    "qt6ct"
    "Kvantum"
    "user-dirs.dirs"
)

# ==============================================================================
# ðŸš€ DÃ‰BUT DU TRAITEMENT
# ==============================================================================
clear
echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE} SYNCHRONISATION VERSO OS (DEV -> ISO) ${NC}"
echo -e "${BLUE}=========================================${NC}"

if [ ! -d "$AIROOTFS" ]; then
    echo -e "${RED}ERREUR : Dossier airootfs introuvable dans $ISO_DIR${NC}"
    exit 1
fi

# 1. SCRIPTS
echo -e "${YELLOW}--> Synchronisation des scripts...${NC}"
mkdir -p "$BIN_DEST"
for item in "${SCRIPTS_TO_SYNC[@]}"; do
    if [ -f "/usr/local/bin/$item" ]; then
        cp -f "/usr/local/bin/$item" "$BIN_DEST/"
        echo -e " âœ… $item"
    else
        echo -e "${RED} âš ï¸ MANQUANT : $item${NC}"
    fi
done
# On copie aussi le script de sync lui-mÃªme pour l'avoir dans l'ISO si besoin
cp -f "$0" "$BIN_DEST/extract-verso"
chmod +x "$BIN_DEST/"*

# 2. CONFIGS
echo ""
echo -e "${YELLOW}--> Synchronisation des configs...${NC}"
mkdir -p "$SKEL_CONFIG"
for item in "${CONFIGS_TO_SYNC[@]}"; do
    SRC="$HOME/.config/$item"
    DEST="$SKEL_CONFIG/$item"
    
    # On vÃ©rifie si c'est un dossier ou un fichier
    if [ -e "$SRC" ]; then
        rm -rf "$DEST" # Nettoyage avant copie
        cp -r "$SRC" "$DEST"
        echo -e " âœ… $item"
    else
        echo -e "${RED} âš ï¸ MANQUANT DANS .CONFIG : $item${NC}"
    fi
done

# 3. IA LOCALE
echo ""
echo -e "${YELLOW}--> IntÃ©gration Alfred/Llama...${NC}"
LLAMA_SRC="$HOME/llama.cpp/tools/cli/cli.cpp"
LLAMA_DEST_DIR="$SKEL/llama.cpp/tools/cli"
if [ -f "$LLAMA_SRC" ]; then
    mkdir -p "$LLAMA_DEST_DIR"
    cp "$LLAMA_SRC" "$LLAMA_DEST_DIR/"
    echo -e " âœ… cli.cpp"
fi

# 4. BRAVE
echo ""
echo -e "${YELLOW}--> Exportation Brave (Clean)...${NC}"
BRAVE_SRC="$HOME/.config/BraveSoftware/Brave-Browser"
BRAVE_DEST="$SKEL_CONFIG/BraveSoftware/Brave-Browser"
if [ -d "$BRAVE_SRC" ]; then
    mkdir -p "$BRAVE_DEST/Default"
    # On copie juste les prefs, pas le cache ni les mots de passe
    [ -f "$BRAVE_SRC/Local State" ] && cp "$BRAVE_SRC/Local State" "$BRAVE_DEST/"
    [ -f "$BRAVE_SRC/Default/Preferences" ] && cp "$BRAVE_SRC/Default/Preferences" "$BRAVE_DEST/Default/"
    echo -e " âœ… ParamÃ¨tres Brave copiÃ©s"
fi

# 5. TERMINAL
echo ""
echo -e "${YELLOW}--> Bashrc & Profil...${NC}"
[ -f "$HOME/.bashrc" ] && cp "$HOME/.bashrc" "$SKEL/.bashrc" && echo " âœ… .bashrc"
[ -f "$HOME/.bash_profile" ] && cp "$HOME/.bash_profile" "$SKEL/.bash_profile" && echo " âœ… .bash_profile"

# 6. EXTRACTION DES LISTES DE PAQUETS
echo ""
echo -e "${YELLOW}--> GÃ©nÃ©ration des listes de paquets...${NC}"
pacman -Qneq > "$ISO_DIR/pkglist_dev_native.txt"
echo -e " ðŸ“¦ Liste Native sauvegardÃ©e : $ISO_DIR/pkglist_dev_native.txt"
pacman -Qmeq > "$ISO_DIR/pkglist_dev_aur.txt"
echo -e " ðŸ“¦ Liste AUR sauvegardÃ©e : $ISO_DIR/pkglist_dev_aur.txt"

echo ""
echo -e "${BLUE}=========================================${NC}"
echo -e "${GREEN} SYNCHRONISATION TERMINÃ‰E ! ðŸš€ ${NC}"
echo -e "${BLUE}=========================================${NC}"

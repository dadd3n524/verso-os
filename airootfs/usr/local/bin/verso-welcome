#!/bin/bash

# --- CONFIGURATION ---
IMG="/usr/share/backgrounds/verso_banner.jpg"
LOCKFILE="$HOME/.config/verso-setup-done"

# Si le fichier témoin existe, on quitte
if [ -f "$LOCKFILE" ]; then
    exit 0
fi

sleep 2

# --- BOUCLE MOT DE PASSE ---
while true; do
    PASS=$(yad --entry \
        --title="Bienvenue sur Verso OS" \
        --window-icon="system-software-update" \
        --image="$IMG" --image-on-top \
        --text="Configuration initiale.\nVeuillez choisir votre mot de passe :" \
        --hide-text \
        --button="Annuler:1" --button="Valider:0" \
        --width=500 --center)

    if [ $? -ne 0 ]; then
        notify-send "Verso OS" "Configuration reportée."
        exit 0
    fi

    # Vérification du sudo
    if echo "$PASS" | sudo -S -v -k 2> /dev/null; then
        break
    else
        yad --error --text="Mot de passe incorrect !" --button="OK"
    fi
done

# --- INSTALLATION ---
(
    echo "10"
    echo "# Mise à jour des dépôts..."
    echo "$PASS" | sudo -S pacman -Sy --noconfirm

    echo "20"
    echo "# Installation des outils de construction..."
    # Nécessaire pour installer Yay et Brave
    echo "$PASS" | sudo -S pacman -S --noconfirm git base-devel

    echo "40"
    echo "# Installation de l'assistant YAY..."
    # Installe yay-bin (version pré-compilée rapide)
    if ! command -v yay &> /dev/null; then
        cd /tmp
        git clone https://aur.archlinux.org/yay-bin.git
        cd yay-bin
        # Rafraîchit le sudo pour que makepkg ne demande pas le mdp
        echo "$PASS" | sudo -S -v
        makepkg -si --noconfirm
        cd ..
    fi

    echo "60"
    echo "# Téléchargement de Brave Browser..."
    # Yay s'utilise sans sudo (il le demandera si besoin, mais on a le cache)
    yay -S --noconfirm brave-bin

    echo "90"
    echo "# Nettoyage..."
    rm -rf /tmp/yay-bin

    echo "100"
    echo "# Terminé ! Bienvenue sur Verso OS."
    sleep 2

) | yad --progress \
    --title="Initialisation Verso OS" \
    --image="$IMG" --image-on-top \
    --percentage=0 --width=500 --center --no-buttons --auto-close

# Marqueur de fin
touch "$LOCKFILE"
notify-send "Verso OS" "Installation terminée avec succès !"

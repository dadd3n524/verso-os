#!/bin/bash

# --- CONFIGURATION ---
IMG="/usr/share/backgrounds/verso_banner.jpg"
LOCKFILE="$HOME/.config/verso-setup-done"

# Si le fichier témoin existe, on quitte
if [ -f "$LOCKFILE" ]; then
    exit 0
fi

sleep 2

# --- BOUCLE MOT DE PASSE ---
while true; do
    echo -e "${CYAN}Veuillez entrer le mot de passe sudo : ${NC}"
    read -s PASS
    echo ""
    # On teste le mot de passe avec sudo -v
    if echo "$PASS" | sudo -S -v -k 2>/dev/null; then
        echo -e "${GREEN}Mot de passe validé!${NC}"
        # On garde le sudo actif pour la suite
        sudo -v 
        break
    else
        echo -e "${RED}Mot de passe incorrect. Réessayez :${NC}"
    fi
done

# --- DÉBUT INSTALLATION ---

echo "10"
echo "# Mise à jour des dépôts..."
echo "$PASS" | sudo -S pacman -Sy --noconfirm

echo "20"
echo "# Installation des paquets critiques (Wlogout)..."
# wlogout est installé ici pour éviter le crash de l'ISO
echo "$PASS" | sudo -S pacman -S --noconfirm wlogout expac

echo "30"
echo "# Installation des outils de construction..."
# Nécessaire pour installer Yay
echo "$PASS" | sudo -S pacman -S --noconfirm git base-devel

echo "40"
echo "# Installation de l'assistant YAY..."
if ! command -v yay &> /dev/null; then
    # On utilise un dossier temporaire propre
    rm -rf /tmp/yay-bin
    cd /tmp
    git clone https://aur.archlinux.org/yay-bin.git
    cd yay-bin
    # Yay n'aime pas être lancé en root, on le lance en user mais makepkg demandera le mdp si besoin
    # Comme on a rafraîchi sudo plus haut, ça devrait passer, sinon on configure makepkg
    makepkg -si --noconfirm
    cd ..
fi

echo "60"
echo "# Téléchargement de Brave Browser..."
yay -S --noconfirm brave-bin

echo "70"
echo "# Vérification Steam..."
# Installation de Steam (Optionnelle)
echo -e "${CYAN}Voulez-vous installer Steam ? (o/n) : ${NC}"
read -r REP_STEAM
if [[ "$REP_STEAM" =~ ^[o0] ]]; then
    echo "Activation de Multilib et installation..."
    # On décommente les lignes multilib dans pacman.conf
    echo "$PASS" | sudo -S sed -i "/\[multilib\]/,/Include/"'s/^#//' /etc/pacman.conf
    echo "$PASS" | sudo -S pacman -Sy
    echo "$PASS" | sudo -S pacman -S --noconfirm steam ttf-liberation
fi

echo "80"
echo "# Vérification de l'intégrité du système..."

# 1. On définit l'URL de ta liste (À CHANGER avec ton vrai lien RAW GitHub/GitLab)
# Si tu préfères utiliser le fichier local de l'ISO, change URL par un chemin :
# LIST_FILE="/usr/share/verso/packages-x86_64"
URL_LIST="https://raw.githubusercontent.com/TON_NOM_USER/TON_REPO/main/archiso/packages-x86_64"
LIST_FILE="/tmp/packages_check.txt"

echo "Téléchargement de la liste de référence..."
if curl -s "$URL_LIST" -o "$LIST_FILE"; then
    
    echo "Analyse des paquets manquants..."
    
    # 2. Nettoyage de la liste pour Pacman
    # sed retire les commentaires (#...) et les lignes vides
    # pacman -S --needed --noconfirm - < liste -> Lit la liste depuis l'entrée standard
    
    sed -e 's/#.*$//' -e '/^$/d' "$LIST_FILE" | \
    sudo pacman -S --needed --noconfirm - 

    echo -e "${GREEN}Système synchronisé avec la définition officielle !${NC}"
else
    echo -e "${RED}Impossible de télécharger la liste des paquets. Étape ignorée.${NC}"
fi

echo "90"
echo "# Nettoyage..."
rm -rf /tmp/yay-bin

echo "100"
echo "# Terminé ! Bienvenue sur Verso OS."
sleep 2

# Marqueur de fin
mkdir -p $(dirname "$LOCKFILE")
touch "$LOCKFILE"

notify-send "Verso OS" "Installation terminée avec succès ! L'interface redémarre..."
sleep 3
systemctl restart sddm

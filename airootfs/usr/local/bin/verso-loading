#!/bin/bash

# --- CONFIGURATION DES COULEURS (ANSI Codes) ---
# Couleurs vives et "Bold" pour le look rétro
C_RESET='\033[0m'
C_RED='\033[1;31m'
C_GREEN='\033[1;32m'
C_YELLOW='\033[1;33m'
C_BLUE='\033[1;34m'
C_MAGENTA='\033[1;35m'
C_CYAN='\033[1;36m'
C_WHITE='\033[1;37m'
C_GREY='\033[0;37m'

# --- FONCTIONS UTILITAIRES ---

# Fonction pour une barre de progression
draw_progress_bar() {
    local width=40
    local percent=$1
    local filled=$(($width * $percent / 100))
    local empty=$(($width - $filled))
    
    printf "\r${C_CYAN}[ "
    printf "%0.s#" $(seq 1 $filled)
    printf "%0.s." $(seq 1 $empty)
    printf " ] ${C_WHITE}$percent%%${C_RESET}"
}

# Fonction pour afficher des statuts [OK]
print_status() {
    local msg=$1
    local status=$2 # 0=OK, 1=WARN, 2=ERR
    
    if [ "$status" -eq 0 ]; then
        echo -e "${C_GREEN}[ OK ]${C_RESET} $msg"
    elif [ "$status" -eq 1 ]; then
        echo -e "${C_YELLOW}[ WARN ]${C_RESET} $msg"
    else
        echo -e "${C_RED}[ FAIL ]${C_RESET} $msg"
    fi
    sleep 0.1
}

# Fonction pour simuler du bruit hexadécimal/mémoire
hex_dump() {
    for i in {1..15}; do
        echo -e "${C_GREY}0x$(openssl rand -hex 4) $(openssl rand -hex 4) $(openssl rand -hex 4) $(openssl rand -hex 4) :: MEM_ALLOC_VSO${C_RESET}"
        sleep 0.02
    done
}

clear

# --- 1. BOOTLOADER / LOGO ---
echo -e "${C_MAGENTA}"
cat << "EOF"
 __ __ _______ _______ _______ ________   
| \ / \| \ | \ / \ | \  
 \ \ / / | $$$$$$$\| $$$$$$$\| $$$$$$$ \$$$$$$$$  
  \ \/ / | $$__| $$| $$__| $$| $$ | $$ | $$     
   \ / | $$ $$| $$ $$| $$ | $$ | $$     
    \ / | $$$$$$$$| $$$$$$$\| $$ | $$ | $$     
     \ | $$ | $$| $$ | $$| $$__/ $$ | $$     
      \ | $$ | $$| $$ | $$ \$$ $$ | $$     
       \ \$$ \$$ \$$ \$$ \$$$$$$$ \$$     
                                                       
             >> SYSTEME D'EXPLOITATION VERSO <<
             >> ARCHITECTURE SYSTÈME x86_64 <<
EOF
echo -e "${C_RESET}"
sleep 1

echo -e "${C_CYAN}Initialisation du Bootloader V.0.9.8-alpha...${C_RESET}"
sleep 0.5
echo -e "Détection du matériel..."
sleep 0.5

# Simuler des vérifications matérielles
print_status "CPU: Architecture Neural-Link détectée" 0
print_status "RAM: 64TB Crystal Memory - Vérification intégrité" 0
print_status "GPU: Accélération Flux Quantique activée" 0
print_status "Montage du système de fichiers virtuel /dev/vrso0" 0

echo ""
echo -e "${C_YELLOW}>> DÉCHIFFREMENT DE LA CLEF MAITRE <<${C_RESET}"
hex_dump
print_status "Clef acceptée. Accès Root accordé." 0
sleep 1

# --- 2. INSTALLATION DU NOYAU (Barre de progression) ---
echo ""
echo -e "${C_WHITE}Installation du noyau Verso-Kernel-5.19.x${C_RESET}"
for i in $(seq 1 100); do
    draw_progress_bar $i
    sleep 0.03
done
echo -e "\n${C_GREEN}>> Noyau chargé en mémoire vive.${C_RESET}"
sleep 1

# --- 3. DÉPLOIEMENT DES PAQUETS (Le long défilement) ---
echo ""
echo -e "${C_CYAN}>> DÉPLOIEMENT DES MODULES SYSTÈME <<${C_RESET}"
sleep 0.5

# Liste de mots fictifs pour générer du texte aléatoire
modules=("core" "net" "visual" "audio" "haptic" "synapse" "driver" "daemon" "proton" "flux" "matrix" "grid" "shader" "vulcan" "wayland" "hypr" "arch" "pacman" "mirror" "buffer")
extensions=(".ko" ".so" ".bin" ".vso" ".dat" ".enc")
actions=("Compiling" "Linking" "Extracting" "Verifying" "Optimizing")

# Boucle longue pour l'effet de défilement (modifier 500 pour plus ou moins de temps)
for i in {1..400}; do
    # Sélection aléatoire des mots
    act=${actions[$RANDOM % ${#actions[@]}]}
    mod=${modules[$RANDOM % ${#modules[@]}]}
    ext=${extensions[$RANDOM % ${#extensions[@]}]}
    ver=$((RANDOM % 10)).$((RANDOM % 99))
    
    # Couleur aléatoire pour varier les lignes
    rand_col=$((RANDOM % 3))
    if [ $rand_col -eq 0 ]; then LINE_COL=$C_GREEN; 
    elif [ $rand_col -eq 1 ]; then LINE_COL=$C_CYAN; 
    else LINE_COL=$C_GREY; fi

    echo -e "${LINE_COL}:: $act target: /usr/lib/verso/$mod/v$ver/module_$mod$ext ...${C_RESET}"
    
    # Vitesse de défilement (très rapide)
    sleep 0.005
    
    # Parfois, faire une petite pause ou une "erreur" fictive
    if [ $((i % 75)) -eq 0 ]; then
        sleep 0.3
        echo -e "${C_YELLOW}[ WAIT ] Optimisation des shaders en cours...${C_RESET}"
        sleep 0.3
    fi
    if [ $((i % 153)) -eq 0 ]; then
        echo -e "${C_MAGENTA}>> INJECTION DE CODE VERSO :: BLOC $RANDOM <<${C_RESET}"
        sleep 0.1
    fi
done

# --- 4. CONFIGURATION HYPRLAND / ARCH ---
echo ""
echo -e "${C_WHITE}>> FINALISATION DE L'ENVIRONNEMENT <<${C_RESET}"
sleep 1

print_status "Liaison avec la base Arch Linux" 0
print_status "Configuration du compositeur Hyprland" 0
print_status "Génération des fichiers de configuration .conf" 0
echo -e "${C_GREY} -> ~/.config/hypr/hyprland.conf ... OK${C_RESET}"
echo -e "${C_GREY} -> ~/.config/waybar/config ... OK${C_RESET}"

print_status "Démarrage du service audio Pipewire" 0
print_status "Initialisation de l'interface utilisateur Verso UI" 0

sleep 1
echo ""
echo -e "${C_CYAN}##################################################${C_RESET}"
echo -e "${C_CYAN}# INSTALLATION TERMINÉE #${C_RESET}"
echo -e "${C_CYAN}##################################################${C_RESET}"
echo ""
echo -e "Bienvenue dans ${C_MAGENTA}VERSO OS${C_RESET}."
echo -e "Prêt pour l'initialisation de la session graphique."
echo ""
echo -n "Rebooting in 3"
sleep 1
echo -n "."
sleep 1
echo -n "."
sleep 1
echo -e " NOW."
sleep 0.5
clear

#!/bin/bash

# --- COULEURS POUR LE STYLE ---
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
YELLOW='\033[1;33m'
PINK='\033[1;35m'
ORANGE='\033[0;33m'
NC='\033[0m'

clear
echo -e "${BLUE}======================================================${NC}"
echo -e "${BLUE} BIENVENUE DANS L'INSTALLATEUR${NC} ${GREEN}V${NC}${PURPLE}E${NC}${CYAN}R${NC}${RED}S${NC}${YELLOW}O${NC} ${PINK}O${NC}${ORANGE}S ${NC}"
echo -e "${BLUE}======================================================${NC}"
echo ""
echo "Configuration du systÃ¨me."
echo ""

# --- Ã‰TAPE 1 : SÃ‰LECTION DES DISQUES ---
echo -e "${CYAN}--- Ã‰TAPE 1 : SÃ‰LECTION DES DISQUES ---${NC}"
echo "Disques dÃ©tectÃ©s :"

DISKS=($(lsblk -d -n -o NAME | grep -v "loop" | grep -v "airoot" | grep -v "rom"))

i=0
for disk in "${DISKS[@]}"; do
    INFO=$(lsblk -d -n -o SIZE,MODEL /dev/$disk)
    echo -e " ${GREEN}[$i]${NC} /dev/$disk ($INFO)"
    ((i++))
done

echo ""
read -p "NUMÃ‰RO du disque Ã  utiliser (ex: 0, 1, 2...) : " DISK_INDEX

if [[ -z "${DISKS[$DISK_INDEX]}" ]]; then
    echo -e "${RED}Erreur : Choix invalide.${NC}"
    exit 1
else
    TARGET_DISK="/dev/${DISKS[$DISK_INDEX]}"
    echo -e "-> Disque sÃ©lectionnÃ© : ${GREEN}$TARGET_DISK${NC}"
fi

if [ ! -b "$TARGET_DISK" ]; then
    echo -e "${RED}Erreur critique : Le pÃ©riphÃ©rique est introuvable.${NC}"
    exit 1
fi

# --- Ã‰TAPE 2 : CONFIRMATION ---
clear
echo -e "${RED}!!! ATTENTION !!!${NC}"
echo -e "Le disque ${RED}$TARGET_DISK${NC} sera TOTALEMENT EFFACÃ‰."
echo ""
echo -e "${CYAN}RÃ‰CAPITULATIF :${NC}"
echo "------------------------------------------------"
echo -e "1. SystÃ¨me : Verso OS"
echo -e "2. Utilisateur : ${GREEN}verso${NC} (Administrateur)"
echo -e "3. Mot de passe : ${GREEN}verso${NC} (Pour root et user)"
echo "------------------------------------------------"
echo ""
read -p "Es-tu prÃªt Ã  lancer l'installation ? (o/n) : " CONFIRM
if [[ "$CONFIRM" != "o" ]]; then
    echo "Installation annulÃ©e."
    exit 0
fi

# --- Ã‰TAPE 3 : PRÃ‰PARATION DISQUE ---
echo ""
echo -e "${GREEN}--> PrÃ©paration du disque $TARGET_DISK...${NC}"

wipefs -a "$TARGET_DISK"
sgdisk -Z "$TARGET_DISK" 2>/dev/null

MOUNTPOINT="/mnt/archinstall"
mkdir -p "$MOUNTPOINT"

if [[ "$TARGET_DISK" == *"nvme"* ]]; then P="p"; else P=""; fi

# Partitionnement UEFI vs BIOS
if [ -d /sys/firmware/efi/efivars ]; then
    echo "Mode UEFI dÃ©tectÃ©."
    sgdisk -n 1:0:+512M -t 1:ef00 -c 1:"EFI System" "$TARGET_DISK"
    sgdisk -n 2:0:0 -t 2:8300 -c 2:"Verso OS" "$TARGET_DISK"
   
    mkfs.fat -F32 "${TARGET_DISK}${P}1"
    mkfs.ext4 -F "${TARGET_DISK}${P}2"
   
    # Montage (CRITIQUE : Ordre strict pour le kernel)
    mount "${TARGET_DISK}${P}2" "$MOUNTPOINT"
    mkdir -p "$MOUNTPOINT/boot"
    mount "${TARGET_DISK}${P}1" "$MOUNTPOINT/boot"
else
    echo "Mode BIOS (Legacy) dÃ©tectÃ©."
    echo -e "o\nn\np\n1\n\n\nw\n" | fdisk "$TARGET_DISK"
    mkfs.ext4 -F "${TARGET_DISK}${P}1"
    mount "${TARGET_DISK}${P}1" "$MOUNTPOINT"
fi

# --- CRÃ‰ATION DE VCONSOLE ---
echo -e "${GREEN}--> Configuration des paramÃ¨tres systÃ¨me...${NC}"
mkdir -p "$MOUNTPOINT/etc"
echo "KEYMAP=cf" > "$MOUNTPOINT/etc/vconsole.conf"

# --- Ã‰TAPE 4 : INSTALLATION DU COEUR ---
echo -e "${GREEN}--> TÃ©lÃ©chargement et installation du systÃ¨me...${NC}"
# Ajout explicite de 'sudo'
pacstrap -K "$MOUNTPOINT" base linux linux-firmware base-devel networkmanager pipewire nano git sudo

# GÃ©nÃ©ration Fstab
genfstab -U "$MOUNTPOINT" >> "$MOUNTPOINT/etc/fstab"

# --- Ã‰TAPE 5 : CONFIGURATION INTERNE (CHROOT) ---
echo -e "${GREEN}--> Configuration interne...${NC}"

arch-chroot "$MOUNTPOINT" /bin/bash <<EOF
    # 1. Config Locale
    ln -sf /usr/share/zoneinfo/Canada/Eastern /etc/localtime
    hwclock --systohc
    echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
    locale-gen
    echo "LANG=en_US.UTF-8" > /etc/locale.conf
    echo "verso-pc" > /etc/hostname

    # 2. Utilisateurs & Mots de passe
    echo "Configuration des mots de passe..."
    echo "root:verso" | chpasswd
   
    # --- CRÃ‰ATION UTILISATEUR ---
    useradd -m -G wheel -s /bin/bash verso
    echo "verso:verso" | chpasswd
    
    # Autoriser le groupe wheel pour sudo
    echo "%wheel ALL=(ALL:ALL) ALL" > /etc/sudoers.d/wheel_admin
    chmod 440 /etc/sudoers.d/wheel_admin

    # --- SDDM ---
    mkdir -p /etc/sddm.conf.d
    echo "[Users]" > /etc/sddm.conf.d/uid.conf
    echo "MinimumUid=1000" >> /etc/sddm.conf.d/uid.conf
    echo "HideShells=/sbin/nologin,/bin/false" >> /etc/sddm.conf.d/uid.conf
   
    # 3. Bootloader
    if [ -d /sys/firmware/efi/efivars ]; then
        bootctl install
        echo "default verso.conf" > /boot/loader/loader.conf
        echo "timeout 3" >> /boot/loader/loader.conf
       
        echo "title Verso OS" > /boot/loader/entries/verso.conf
        echo "linux /vmlinuz-linux" >> /boot/loader/entries/verso.conf
        echo "initrd /initramfs-linux.img" >> /boot/loader/entries/verso.conf
        
        # ICI : PAS DE BACKSLASH DEVANT $(blkid).
        # L'installateur (hÃ´te) calcule l'UUID maintenant et l'Ã©crit en dur dans le fichier.
        echo "options root=PARTUUID=$(blkid -s PARTUUID -o value ${TARGET_DISK}${P}2) rw" >> /boot/loader/entries/verso.conf
    else
        pacman -S --noconfirm grub
        grub-install --target=i386-pc "$TARGET_DISK"
        grub-mkconfig -o /boot/grub/grub.cfg
    fi
EOF

# --- Ã‰TAPE 6 : FINITIONS & PAQUETS ---
if [ -d "$MOUNTPOINT" ]; then
    echo ""
    echo -e "${GREEN}--> Installation des paquets supplÃ©mentaires...${NC}"
   
    if [ -f /pkglist.txt ]; then
        cat /pkglist.txt | arch-chroot $MOUNTPOINT pacman -S --needed --noconfirm -
    else
        echo -e "${RED}Attention : pkglist.txt non trouvÃ©.${NC}"
    fi

    echo -e "${GREEN}--> Configuration finale du systÃ¨me...${NC}"
   
    # Copie des configs pour l'utilisateur VERSO
    if [ -d /etc/skel/.config ]; then
        cp -r /etc/skel/.config "$MOUNTPOINT/home/verso/"
        arch-chroot "$MOUNTPOINT" chown -R verso:verso /home/verso/.config
    fi

    echo -e "${GREEN}--> Activation des services...${NC}"
    arch-chroot $MOUNTPOINT systemctl enable sddm
    arch-chroot $MOUNTPOINT systemctl enable NetworkManager
    arch-chroot $MOUNTPOINT systemctl enable bluetooth

    # --- FIN ZEN ---
    umount -R "$MOUNTPOINT" 2>/dev/null

    echo ""
    echo -e "${BLUE}======================================================${NC}"
    echo -e "${BLUE} INSTALLATION TERMINÃ‰E AVEC SUCCÃˆS ! ðŸš€ ${NC}"
    echo -e "${BLUE}======================================================${NC}"
    echo ""
    echo -e "L'utilisateur est : ${GREEN}verso${NC}"
    echo -e "Le mot de passe est : ${GREEN}verso${NC}"
    echo ""
    echo "Tu peux maintenant retirer la clÃ© USB."
    echo "Appuie sur ENTRÃ‰E pour Ã©teindre l'ordinateur."
    read -p ""
    poweroff
else
    echo -e "${RED}Erreur critique : Ã‰chec de l'installation.${NC}"
fi
